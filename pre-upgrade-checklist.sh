#!/bin/bash

# ============================================================================
# PostgreSQL Upgrade Pre-Flight Checklist
# Project: Numerix (kmndhvzjyhyiwwdmgyqg)
# ============================================================================

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ” PostgreSQL Upgrade Pre-Flight Checklist"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo "ğŸ“‹ PRE-UPGRADE CHECKLIST"
echo ""
echo "Before running the upgrade, complete these steps:"
echo ""
echo "1. âœ… Run SQL Pre-Upgrade Checks"
echo "   â†’ Open Supabase Dashboard â†’ SQL Editor"
echo "   â†’ Run queries from: sql/postgres-upgrade-checks.sql"
echo "   â†’ Save all results (version, extensions, row counts)"
echo ""
echo "2. âœ… Create Database Backup"
echo "   â†’ Run: ./backup-database.sh"
echo "   â†’ OR use Supabase Dashboard â†’ Database â†’ Backups"
echo ""
echo "3. âœ… Verify Backup"
echo "   â†’ Test restore to staging (if available)"
echo "   â†’ Verify backup file exists and is valid"
echo ""
echo "4. âœ… Schedule Maintenance Window"
echo "   â†’ Expected downtime: 5-15 minutes"
echo "   â†’ Notify users/stakeholders"
echo ""
echo "5. âœ… Check Application Status"
echo "   â†’ Ensure no critical operations running"
echo "   â†’ Document current version"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“Š SQL CHECKS TO RUN (in Supabase SQL Editor)"
echo ""
echo "Run these queries from sql/postgres-upgrade-checks.sql:"
echo ""
echo "  [ ] 1. Current Postgres Version"
echo "  [ ] 2. Installed Extensions"
echo "  [ ] 3. Extension Objects Check"
echo "  [ ] 4. Critical Extensions Version"
echo "  [ ] 5. Active Connections"
echo "  [ ] 6. Long-Running Queries"
echo "  [ ] 7. Table Row Counts"
echo "  [ ] 8. Index Bloat/Vacuum"
echo "  [ ] 9. Replication Status"
echo "  [ ] 10. Security-Definer Functions"
echo "  [ ] 11. Deprecated Features"
echo "  [ ] 12. Numerix-Specific Tables"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸš€ UPGRADE STEPS"
echo ""
echo "1. Go to: https://supabase.com/dashboard/project/kmndhvzjyhyiwwdmgyqg/settings/database"
echo ""
echo "2. Click 'Upgrade' or 'Change Version'"
echo ""
echo "3. Select latest patched version"
echo ""
echo "4. Follow the upgrade wizard"
echo ""
echo "5. Wait for completion (5-15 minutes)"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "âœ… POST-UPGRADE VERIFICATION"
echo ""
echo "Run these checks immediately after upgrade:"
echo ""
echo "  [ ] 1. Verify new version (SELECT version();)"
echo "  [ ] 2. Check extensions still present"
echo "  [ ] 3. Verify row counts match pre-upgrade"
echo "  [ ] 4. Test application queries"
echo "  [ ] 5. Check for errors in logs"
echo "  [ ] 6. Run application smoke tests"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“ FILES AVAILABLE"
echo ""
echo "  â€¢ sql/postgres-upgrade-checks.sql - All SQL checks"
echo "  â€¢ backup-database.sh - Backup script"
echo "  â€¢ UPGRADE_POSTGRES.md - Detailed guide"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
